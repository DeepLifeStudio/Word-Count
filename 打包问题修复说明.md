# PyInstaller 打包问题修复说明

## 问题描述

打包后的应用运行时报错：
```
RuntimeError: Directory 'static' does not exist
```

## 问题原因

PyInstaller 打包后，资源文件（`static` 和 `templates` 目录）会被解压到临时目录 `sys._MEIPASS` 中，而不是应用的当前工作目录。

原代码直接使用相对路径：
```python
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")
```

这在开发环境中可以正常工作，但在打包后的环境中会找不到这些目录。

## 解决方案

添加了 `get_resource_path()` 函数来自动检测运行环境并返回正确的资源路径：

```python
def get_resource_path(relative_path):
    """
    获取资源文件的绝对路径，兼容开发环境和 PyInstaller 打包后的环境
    PyInstaller 会将资源文件解压到 sys._MEIPASS 临时目录
    """
    if hasattr(sys, '_MEIPASS'):
        # PyInstaller 打包后的临时路径
        return os.path.join(sys._MEIPASS, relative_path)
    # 开发环境的相对路径
    return os.path.join(os.path.abspath("."), relative_path)
```

使用该函数获取资源路径：
```python
static_path = get_resource_path("static")
templates_path = get_resource_path("templates")

app.mount("/static", StaticFiles(directory=static_path), name="static")
templates = Jinja2Templates(directory=templates_path)
```

## 工作原理

1. **开发环境**：`hasattr(sys, '_MEIPASS')` 返回 `False`，使用当前目录的相对路径
2. **打包环境**：`hasattr(sys, '_MEIPASS')` 返回 `True`，使用 PyInstaller 的临时目录路径

## GitHub Actions 配置

`.github/workflows/build.yml` 文件已经正确配置了 `--add-data` 参数：

- **Windows**: `--add-data "templates;templates" --add-data "static;static"`
- **macOS**: `--add-data "templates:templates" --add-data "static:static"`

注意 Windows 使用分号 `;`，macOS/Linux 使用冒号 `:`。

## 下次打包

现在可以重新打包应用了：

### 本地打包

```bash
# macOS
./打包Mac应用.sh

# Windows
.\打包Windows应用.bat
```

### GitHub Actions 自动打包

推送一个新的版本标签：
```bash
git add .
git commit -m "fix: 修复打包后找不到 static 目录的问题"
git tag v1.0.1
git push origin main --tags
```

GitHub Actions 会自动构建 Windows 和 macOS 版本，并创建 Release。

## 验证

打包后的应用应该能够正常启动并访问 Web 界面，不再出现 `Directory 'static' does not exist` 错误。
